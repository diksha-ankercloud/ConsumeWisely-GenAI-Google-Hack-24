<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>Insure </title>
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <meta content="" name="keywords" />
  <meta content="" name="description" />

  <!-- Favicon -->
  <link href="img/favicon.ico" rel="icon" />

  <!-- Google Web Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&family=Poppins:wght@600;700&display=swap"
    rel="stylesheet" />
  <!-- Template Stylesheet -->
   
  <link rel="stylesheet" href="{{url_for('static',filename='bootstrap.min.css')}}">
  <link rel="stylesheet" href="{{url_for('static',filename='style1.css')}}">
</head>

<body>
  

  <!-- Navbar Start -->
  <nav class="navbar navbar-expand-lg bg-white navbar-light sticky-top px-4 px-lg-5">
    <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbarCollapse">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarCollapse">
      <div class="navbar-nav mx-auto bg-light rounded pe-4 py-3 py-lg-0">
      </div>
    </div>
    <a href="" class="btn btn-primary px-3 d-none d-lg-block" id="chatbot-button">Chatbot</a>
  </nav>

  <!-- Navbar End -->
   
  <div class="chat"  id="chat-div" style="display: none;">
    <div class="chat-title">
      <h1>Shopmart Assistant</h1>
      <figure class="avatar">
        <img src="{{ url_for('static', filename='shopping.png') }}" alt="Icon">
      </figure>
    </div>
    <div class="messages">
      <div class="messages-content">
        <div class="message new">
          <figure class="avatar">
            <img src="{{ url_for('static', filename='icon2.jfif') }}" alt="Icon">
          </figure> Hi,There I can help you make the right choice for your shopping experience.
        </div>
      </div>
    </div>
    <div class="message-box">
      <textarea type="text" class="message-input" placeholder="Type message..."></textarea>
      <br>
      <input type="file" class="myFile" id="myFile" name="filename" onchange="previewImage(event)">
      <label for="myFile" class="myFileLabel">Choose a file</label>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<img id="image-preview" style="display: none; max-width: 150px; max-height: 150px;" />
      <button type="submit" class="message-submit" onclick="insertMessage()">Send</button>
      <div id="response" class="response-container"></div>
    </div>
    
    <script>
    // Toggle chat window display
    document.getElementById("chatbot-button").addEventListener("click", function(e) {
      e.preventDefault();
      var div = document.getElementById("chat-div");
    
      // Check current display status and toggle it
      if (div.style.display === "none") {
          div.style.display = "flex"; // Show the div
      } else {
          div.style.display = "none";  // Hide the div
      }
    });
    
    // Handle message submission
    function insertMessage() {
      var msg = document.querySelector(".message-input").value.trim();
      var fileInput = document.getElementById("myFile").files[0]; // Get the uploaded image file
    
      if (msg === "" && !fileInput) {
        alert('Please enter a message or upload an image!');
        return false;
      }
    
      var messageDiv = document.createElement("div");
      messageDiv.className = "message message-personal";
      messageDiv.textContent = msg;
    
      document.querySelector(".messages-content").appendChild(messageDiv);
      messageDiv.classList.add("new");
    
      document.querySelector(".message-input").value = ""; // Clear the input field
    
      // If an image is uploaded, preview it
      if (fileInput) {
        previewImage(fileInput);
      }
    
      sendToLLM(msg, fileInput);  // Send both text and image to the server
    }
    
    // Function to preview the uploaded image
    function previewImage(file) {
      const imagePreview = document.createElement("img");
      imagePreview.style.maxWidth = "150px";  // Display the image with smaller size
      imagePreview.style.maxHeight = "150px";
      imagePreview.style.margin = "10px"; 
      imagePreview.style.float = "right";    // Add space around the image
      imagePreview.className = "message-image";
    
      const reader = new FileReader();
      reader.onload = function(e) {
        imagePreview.src = e.target.result;
        document.querySelector(".messages-content").appendChild(imagePreview); // Append the image preview to the chat
      };
      reader.readAsDataURL(file);  // Convert the file to a data URL
    }
    
    // Function to send both message and image to the server
    function sendToLLM(msg, fileInput) {
      const formData = new FormData();
      formData.append('message', msg);  // Add the text input to the form data
    
      if (fileInput) {
        formData.append('image', fileInput);  // Add the image file to the form data if it exists
      }
    
      // Sending FormData directly without setting content-type (it will be set automatically)
      fetch('/get_response', {
        method: 'POST',
        body: formData  // Send form data directly
      })
      .then(response => response.json())
      .then(data => {
        // Display the LLM response in the chat
        var messageDiv = document.createElement("div");
        messageDiv.className = "message new";
        
        // Avatar for bot response

        // Append LLM response to the message div
        messageDiv.innerHTML += data.message;
        
        document.querySelector(".messages-content").appendChild(messageDiv);
        messageDiv.classList.add("new");
      })
      .catch(error => console.error('Error:', error));
    }

    function displayResponse(data) {
            const container = document.getElementById('response');

            let html = '';

            if (data['Product Name']) {
                html += `<div class="response-section"><h2>Product Name</h2><p>${data['Product Name']}</p></div>`;
            }

            for (let i = 1; i <= 5; i++) {
                if (data[`Category ${i}`]) {
                    html += `<div class="response-section"><h2>Category ${i}</h2><p>${data[`Category ${i}`]}</p></div>`;
                }
            }

            if (data['Advice']) {
                html += `<div class="response-section"><h2>Advice</h2><p>${data['Advice']}</p></div>`;
            }

            if (data['Alternative Product']) {
                html += `<div class="response-section"><h2>Alternative Organic Product</h2><p>${data['Alternative Product']}</p></div>`;
            }

            container.innerHTML = html;
        }
    </script>
</body>    
</html>